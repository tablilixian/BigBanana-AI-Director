# 提示词质量优化建议

## 当前状态分析 (2025年12月21日)

### ✅ 已实现的优秀特性

1. **分层的提示词架构**
   - 基础版: 快速生成,token消耗低
   - AI增强版: 专业细节,适合高质量需求
   - 用户可通过开关选择

2. **完整的视觉规格**
   - 技术规格 (分辨率、景深、镜头语言)
   - 视觉细节 (光影、色彩、材质、大气效果)
   - 角色要求 (面部、发型、服装、表情)
   - 环境要求 (背景层次、透视、细节)
   - 氛围营造 (情绪、色彩心理、节奏)
   - 质量保证 (清晰度、一致性、构图)

3. **角色一致性重视**
   ```
   ⚠️ 最高优先级: 如果提供了角色参考图,必须严格保持人物外观的完全一致性!
   • 面部特征必须与参考图一致
   • 发型发色必须完全匹配
   • 服装造型必须保持一致
   ```

4. **参考图优先级策略**
   - 场景参考图 (环境/氛围)
   - 角色参考图 (外观)
   - 支持角色服装变体

---

## ⚠️ 发现的问题

### 问题1: AI增强提示词可能过长
**位置**: `services/geminiService.ts` - `enhanceKeyframePrompt()`

**问题描述**:
```typescript
// 当前实现 - 叠加式
return `${basePrompt}

${result.trim()}`;
```

这会导致:
- 基础提示词(已包含场景、角色、风格、镜头运动) + AI详细描述
- 总长度可能超过图像模型token限制(如Gemini的500 tokens)
- 信息重复,可能降低生成质量

**影响**: 中等 ⚠️
- 可能触发API限制
- 生成质量不稳定

**解决方案**:
```typescript
// 方案A: 只返回AI优化版,不拼接原始
return result.trim();

// 方案B: 智能合并,去重复信息
return mergePrompts(basePrompt, result);

// 方案C: 控制AI生成长度
maxTokens: 2048 // 降到1024-1536
```

**推荐**: 方案A + 在AI提示中明确要求"整合并重写,不要重复"

---

### 问题2: 视频提示词缺少视觉风格
**位置**: `components/StageDirector/utils.ts` - `buildVideoPrompt()`

**问题描述**:
```typescript
// 当前实现
export const buildVideoPrompt = (
  actionSummary: string,
  cameraMovement: string,
  videoModel: 'sora-2' | 'veo_3_1_i2v_s_fast_fl_landscape',
  language: string
): string => {
  // 缺少 visualStyle 参数
}
```

**影响**: 高 🔴
- 首帧/尾帧用"真人实拍"风格生成
- 但视频提示词没有风格约束
- 可能导致图片和视频风格不一致

**解决方案**:
```typescript
export const buildVideoPrompt = (
  actionSummary: string,
  cameraMovement: string,
  videoModel: 'sora-2' | 'veo_3_1_i2v_s_fast_fl_landscape',
  language: string,
  visualStyle: string // 添加
): string => {
  const isChinese = language === '中文' || language === 'Chinese';
  const stylePrompt = VISUAL_STYLE_PROMPTS[visualStyle] || visualStyle;
  
  if (videoModel === 'sora-2') {
    const template = isChinese 
      ? VIDEO_PROMPT_TEMPLATES.sora2.chinese 
      : VIDEO_PROMPT_TEMPLATES.sora2.english;
    
    return template
      .replace('{actionSummary}', actionSummary)
      .replace('{cameraMovement}', cameraMovement)
      .replace('{language}', language)
      .replace('{visualStyle}', stylePrompt); // 新增
  }
  // ...
}
```

并更新模板:
```typescript
VIDEO_PROMPT_TEMPLATES = {
  sora2: {
    chinese: `【画面比例：16:9 宽屏横向格式】从第一张图片（起始帧）到第二张图片（结束帧）生成平滑过渡的视频。

动作描述：{actionSummary}

技术要求：
- 视觉风格：{visualStyle}  // 新增
- 关键：视频必须从第一张图片的精确构图开始...
`
  }
}
```

---

### 问题3: 缺少首尾帧连贯性保证
**位置**: `components/StageDirector/index.tsx` - `handleGenerateKeyframe()`

**问题描述**:
起始帧和结束帧是独立生成的,没有确保它们之间的视觉连贯性。

**影响**: 中等 ⚠️
- 可能出现角色服装突变
- 场景环境差异过大
- 光照条件不一致

**解决方案**:
```typescript
// 生成结束帧时,将起始帧作为参考图
const handleGenerateKeyframe = async (shot: Shot, type: 'start' | 'end') => {
  // ...existing code...
  
  try {
    const referenceImages = getRefImagesForShot(shot, project.scriptData);
    
    // 如果生成结束帧,且起始帧已存在,将其加入参考图
    if (type === 'end') {
      const startKf = shot.keyframes?.find(k => k.type === 'start');
      if (startKf?.imageUrl) {
        referenceImages.push(startKf.imageUrl);
      }
    }
    
    const url = await generateImage(prompt, referenceImages);
    // ...
  }
}
```

---

### 问题4: 缺少负面提示词 (Negative Prompt)
**位置**: 数据结构和生成逻辑

**问题描述**:
- `Scene` 有 `negativePrompt`,但 `Keyframe` 没有
- 无法排除不想要的元素(如多余手指、扭曲面部等)

**影响**: 低 ⚡
- 生成失败率可能较高
- 需要多次重新生成

**解决方案**:
```typescript
// 1. 更新数据结构
export interface Keyframe {
  id: string;
  type: 'start' | 'end';
  visualPrompt: string;
  negativePrompt?: string; // 新增
  imageUrl?: string;
  status: 'pending' | 'generating' | 'completed' | 'failed';
}

// 2. 在 buildKeyframePrompt 中添加通用负面提示
const COMMON_NEGATIVE_PROMPTS = {
  'live-action': 'cartoon, anime, 3d render, blurry, distorted faces, extra fingers, watermark',
  'anime': 'photorealistic, western style, realistic proportions, 3d render',
  // ...
};

// 3. 在 generateImage 调用时传入
await generateImage(prompt, referenceImages, negativePrompt);
```

---

### 问题5: 镜头运动指导可能不够具体
**位置**: `components/StageDirector/cameraMovementGuides.ts`

**问题描述**:
虽然有构图指导,但对于复杂镜头运动(如Dolly Zoom),缺少详细的视觉效果描述。

**影响**: 低 ⚡
- 生成的关键帧可能不够明显展现运动差异

**解决方案**:
为每种镜头运动添加更详细的起始帧/结束帧差异描述。

---

## 🎯 优化优先级

### 🔴 **高优先级** (立即修复)
1. **问题2**: 视频提示词添加视觉风格
   - 影响: 图片和视频风格不一致
   - 修复难度: 低
   - 预期效果: 显著提升视频质量

### ⚠️ **中优先级** (近期优化)
2. **问题1**: 优化AI增强提示词长度
   - 影响: API限制和质量不稳定
   - 修复难度: 中
   - 预期效果: 提升稳定性

3. **问题3**: 添加首尾帧连贯性
   - 影响: 帧间一致性
   - 修复难度: 低
   - 预期效果: 提升动画流畅度

### ⚡ **低优先级** (后续增强)
4. **问题4**: 添加负面提示词
5. **问题5**: 增强镜头运动指导

---

## 📝 测试建议

### 测试场景1: 角色一致性
- 上传明确的角色参考图
- 生成多个镜头的关键帧
- 检查角色外观是否保持一致

### 测试场景2: 风格一致性
- 选择特定视觉风格(如"anime")
- 生成关键帧和视频
- 对比风格是否匹配

### 测试场景3: 镜头运动表现
- 选择复杂镜头运动(如"Dolly Zoom")
- 检查起始帧和结束帧是否明显体现运动

### 测试场景4: 长提示词处理
- 使用AI增强模式
- 观察是否有API限制错误
- 对比生成质量

---

## 🚀 实施计划

### Phase 1: 修复高优先级问题 (1-2天)
- [ ] 修改 `buildVideoPrompt` 添加视觉风格参数
- [ ] 更新 `handleGenerateVideo` 传入视觉风格
- [ ] 更新视频提示词模板
- [ ] 测试不同视觉风格的视频生成

### Phase 2: 优化中优先级问题 (3-5天)
- [ ] 重构 `enhanceKeyframePrompt` 避免过长提示词
- [ ] 添加首尾帧连贯性逻辑
- [ ] 测试不同场景下的帧一致性

### Phase 3: 增强功能 (可选)
- [ ] 添加负面提示词支持
- [ ] 优化镜头运动指导
- [ ] 添加质量评估工具

---

## 📚 相关文档
- [AI增强提示词功能说明](./AI增强提示词功能说明.md)
- [AI关键帧优化功能说明](./AI关键帧优化功能说明.md)
- [镜头提示词参考](./镜头提示词.md)
