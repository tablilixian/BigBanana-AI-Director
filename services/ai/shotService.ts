/**
 * åˆ†é•œè¾…åŠ©æœåŠ¡
 * åŒ…å«å…³é”®å¸§ä¼˜åŒ–ã€åŠ¨ä½œç”Ÿæˆã€é•œå¤´æ‹†åˆ†ã€ä¹å®«æ ¼åˆ†é•œç­‰åŠŸèƒ½
 */

import { AspectRatio, NineGridPanel } from "../../types";
import { addRenderLogWithTokens } from '../renderLogService';
import {
  retryOperation,
  cleanJsonString,
  chatCompletion,
  getActiveChatModel,
} from './apiCore';
import { getStylePromptCN, getStylePrompt } from './promptConstants';
import { generateImage } from './visualService';

// ============================================
// å…³é”®å¸§ä¼˜åŒ–
// ============================================

/**
 * AIä¸€æ¬¡æ€§ä¼˜åŒ–èµ·å§‹å¸§å’Œç»“æŸå¸§è§†è§‰æè¿°ï¼ˆæ¨èä½¿ç”¨ï¼‰
 */
export const optimizeBothKeyframes = async (
  actionSummary: string,
  cameraMovement: string,
  sceneInfo: { location: string; time: string; atmosphere: string },
  characterInfo: string[],
  visualStyle: string,
  model: string = 'gpt-5.1'
): Promise<{ startPrompt: string; endPrompt: string }> => {
  console.log('ğŸ¨ optimizeBothKeyframes è°ƒç”¨ - åŒæ—¶ä¼˜åŒ–èµ·å§‹å¸§å’Œç»“æŸå¸§ - ä½¿ç”¨æ¨¡å‹:', model);
  const startTime = Date.now();

  const styleDesc = getStylePromptCN(visualStyle);

  const prompt = `
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç”µå½±è§†è§‰å¯¼æ¼”å’Œæ¦‚å¿µè‰ºæœ¯å®¶ã€‚è¯·ä¸ºä»¥ä¸‹é•œå¤´åŒæ—¶åˆ›ä½œèµ·å§‹å¸§å’Œç»“æŸå¸§çš„è¯¦ç»†è§†è§‰æè¿°ã€‚

## åœºæ™¯ä¿¡æ¯
**åœ°ç‚¹ï¼š** ${sceneInfo.location}
**æ—¶é—´ï¼š** ${sceneInfo.time}
**æ°›å›´ï¼š** ${sceneInfo.atmosphere}

## å™äº‹åŠ¨ä½œ
${actionSummary}

## é•œå¤´è¿åŠ¨
${cameraMovement}

## è§’è‰²ä¿¡æ¯
${characterInfo.length > 0 ? characterInfo.join('ã€') : 'æ— ç‰¹å®šè§’è‰²'}

## è§†è§‰é£æ ¼
${styleDesc}

## ä»»åŠ¡è¦æ±‚

ä½ éœ€è¦ä¸ºè¿™ä¸ª8-10ç§’çš„é•œå¤´åˆ›ä½œ**èµ·å§‹å¸§**å’Œ**ç»“æŸå¸§**ä¸¤ä¸ªå…³é”®ç”»é¢çš„è§†è§‰æè¿°ã€‚

### èµ·å§‹å¸§è¦æ±‚ï¼š
â€¢ å»ºç«‹æ¸…æ™°çš„åˆå§‹åœºæ™¯å’Œäººç‰©çŠ¶æ€
â€¢ ä¸ºå³å°†å‘ç”Ÿçš„åŠ¨ä½œé¢„ç•™è§†è§‰ç©ºé—´å’ŒåŠ¨åŠ¿
â€¢ è®¾å®šå…‰å½±å’Œè‰²è°ƒåŸºè°ƒ
â€¢ å±•ç°è§’è‰²çš„èµ·å§‹è¡¨æƒ…ã€å§¿æ€å’Œä½ç½®
â€¢ æ ¹æ®é•œå¤´è¿åŠ¨ï¼ˆ${cameraMovement}ï¼‰è®¾ç½®åˆé€‚çš„åˆå§‹æ„å›¾
â€¢ è¥é€ åœºæ™¯æ°›å›´ï¼Œè®©è§‚ä¼—æ˜ç¡®æ•…äº‹çš„èµ·ç‚¹

### ç»“æŸå¸§è¦æ±‚ï¼š
â€¢ å±•ç°åŠ¨ä½œå®Œæˆåçš„æœ€ç»ˆçŠ¶æ€å’Œç»“æœ
â€¢ ä½“ç°é•œå¤´è¿åŠ¨ï¼ˆ${cameraMovement}ï¼‰å¸¦æ¥çš„è§†è§’å’Œæ„å›¾å˜åŒ–
â€¢ å±•ç°è§’è‰²çš„æƒ…ç»ªå˜åŒ–ã€æœ€ç»ˆå§¿æ€å’Œä½ç½®
â€¢ å¯ä»¥æœ‰æˆå‰§æ€§çš„å…‰å½±å’Œè‰²å½©å˜åŒ–
â€¢ è¾¾åˆ°è§†è§‰é«˜æ½®æˆ–æƒ…ç»ªé‡Šæ”¾ç‚¹
â€¢ ä¸ºä¸‹ä¸€ä¸ªé•œå¤´çš„è¡”æ¥åšå‡†å¤‡

### ä¸¤å¸§åè°ƒæ€§ï¼š
âš ï¸ **å…³é”®**ï¼šèµ·å§‹å¸§å’Œç»“æŸå¸§å¿…é¡»åœ¨è§†è§‰ä¸Šè¿è´¯åè°ƒ
- ä¿æŒä¸€è‡´çš„è§†è§‰é£æ ¼å’Œè‰²è°ƒåŸºç¡€
- é•œå¤´è¿åŠ¨è½¨è¿¹è¦æ¸…æ™°å¯æ¨å¯¼
- äººç‰©/ç‰©ä½“çš„ç©ºé—´ä½ç½®å˜åŒ–è¦åˆç†
- å…‰å½±å˜åŒ–è¦æœ‰é€»è¾‘æ€§
- ä¸¤å¸§æè¿°åº”è¯¥èƒ½å¤Ÿè‡ªç„¶ä¸²è”æˆä¸€ä¸ªæµç•…çš„è§†è§‰å™äº‹

### æ¯å¸§å¿…é¡»åŒ…å«çš„è§†è§‰å…ƒç´ ï¼š

**1. æ„å›¾ä¸æ™¯åˆ«**
- æ ¹æ®é•œå¤´è¿åŠ¨ç¡®å®šç”»é¢æ¡†æ¶å’Œè§†è§’
- ä¸»ä½“åœ¨ç”»é¢ä¸­çš„ä½ç½®å’Œå¤§å°
- å‰æ™¯ã€ä¸­æ™¯ã€èƒŒæ™¯çš„å±‚æ¬¡å…³ç³»

**2. å…‰å½±ä¸è‰²å½©**
- å…‰æºçš„æ–¹å‘ã€å¼ºåº¦å’Œè‰²æ¸©
- ä¸»å…‰ã€è¾…å…‰ã€è½®å»“å…‰çš„é…ç½®
- æ•´ä½“è‰²è°ƒå’Œè‰²å½©æƒ…ç»ªï¼ˆæš–è‰²/å†·è‰²ï¼‰
- é˜´å½±çš„é•¿åº¦å’Œå¯†åº¦

**3. è§’è‰²ç»†èŠ‚**ï¼ˆå¦‚æœ‰ï¼‰
- é¢éƒ¨è¡¨æƒ…å’Œçœ¼ç¥æ–¹å‘
- è‚¢ä½“å§¿æ€å’Œé‡å¿ƒåˆ†å¸ƒ
- æœè£…çŠ¶æ€å’Œç»†èŠ‚
- ä¸ç¯å¢ƒçš„äº’åŠ¨å…³ç³»

**4. ç¯å¢ƒç»†èŠ‚**
- åœºæ™¯çš„å…·ä½“è§†è§‰å…ƒç´ 
- ç¯å¢ƒæ°›å›´ï¼ˆé›¾æ°”ã€å…‰æŸã€ç²’å­ç­‰ï¼‰
- èƒŒæ™¯çš„æ¸…æ™°åº¦å’Œæ™¯æ·±æ•ˆæœ
- ç¯å¢ƒå¯¹å™äº‹çš„æ”¯æŒ

**5. è¿åŠ¨æš—ç¤º**
- åŠ¨æ€æ¨¡ç³Šæˆ–é™æ­¢æ¸…æ™°
- è¿åŠ¨æ–¹å‘çš„è§†è§‰å¼•å¯¼
- å¼ åŠ›å’ŒåŠ¨åŠ¿çš„ä½“ç°

**6. ç”µå½±æ„Ÿç»†èŠ‚**
- ç”»é¢è´¨æ„Ÿå’Œæè´¨
- å¤§æ°”é€è§†æ•ˆæœ
- ç”µå½±çº§çš„è§†è§‰ç‰¹å¾

## è¾“å‡ºæ ¼å¼

è¯·æŒ‰ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼ˆæ³¨æ„ï¼šæè¿°æ–‡æœ¬ç”¨ä¸­æ–‡ï¼Œæ¯ä¸ªçº¦100-150å­—ï¼‰ï¼š

\`\`\`json
{
  "startFrame": "èµ·å§‹å¸§çš„è¯¦ç»†è§†è§‰æè¿°...",
  "endFrame": "ç»“æŸå¸§çš„è¯¦ç»†è§†è§‰æè¿°..."
}
\`\`\`

âŒ é¿å…ï¼š
- ä¸è¦åœ¨æè¿°ä¸­åŒ…å«"Visual Style:"ç­‰æ ‡ç­¾
- ä¸è¦åˆ†æ®µæˆ–ä½¿ç”¨é¡¹ç›®ç¬¦å·
- ä¸è¦è¿‡äºæŠ€æœ¯åŒ–çš„æœ¯è¯­
- ä¸è¦æè¿°æ•´ä¸ªåŠ¨ä½œè¿‡ç¨‹ï¼Œåªæè¿°ç”»é¢æœ¬èº«

âœ… è¿½æ±‚ï¼š
- æµç•…çš„å•æ®µæè¿°
- å¯Œæœ‰ç”»é¢æ„Ÿçš„è¯­è¨€
- ä¸¤å¸§æè¿°ç›¸äº’å‘¼åº”ã€é€»è¾‘è¿è´¯
- ä¸å™äº‹åŠ¨ä½œå’Œé•œå¤´è¿åŠ¨åè°ƒä¸€è‡´
- å…·ä½“ã€å¯è§†è§‰åŒ–çš„ç»†èŠ‚

è¯·å¼€å§‹åˆ›ä½œï¼š
`;

  try {
    const result = await retryOperation(() => chatCompletion(prompt, model, 0.7, 2048, 'json_object'));
    const duration = Date.now() - startTime;

    const cleaned = cleanJsonString(result);
    const parsed = JSON.parse(cleaned);

    if (!parsed.startFrame || !parsed.endFrame) {
      throw new Error('AIè¿”å›çš„JSONæ ¼å¼ä¸æ­£ç¡®');
    }

    console.log('âœ… AIåŒæ—¶ä¼˜åŒ–èµ·å§‹å¸§å’Œç»“æŸå¸§æˆåŠŸï¼Œè€—æ—¶:', duration, 'ms');

    return {
      startPrompt: parsed.startFrame.trim(),
      endPrompt: parsed.endFrame.trim()
    };
  } catch (error: any) {
    console.error('âŒ AIå…³é”®å¸§ä¼˜åŒ–å¤±è´¥:', error);
    throw new Error(`AIå…³é”®å¸§ä¼˜åŒ–å¤±è´¥: ${error.message}`);
  }
};

/**
 * AIä¼˜åŒ–å•ä¸ªå…³é”®å¸§è§†è§‰æè¿°ï¼ˆå…¼å®¹æ—§ç‰ˆï¼Œå»ºè®®ä½¿ç”¨ optimizeBothKeyframesï¼‰
 */
export const optimizeKeyframePrompt = async (
  frameType: 'start' | 'end',
  actionSummary: string,
  cameraMovement: string,
  sceneInfo: { location: string; time: string; atmosphere: string },
  characterInfo: string[],
  visualStyle: string,
  model: string = 'gpt-5.1'
): Promise<string> => {
  console.log(`ğŸ¨ optimizeKeyframePrompt è°ƒç”¨ - ${frameType === 'start' ? 'èµ·å§‹å¸§' : 'ç»“æŸå¸§'} - ä½¿ç”¨æ¨¡å‹:`, model);
  const startTime = Date.now();

  const frameLabel = frameType === 'start' ? 'èµ·å§‹å¸§' : 'ç»“æŸå¸§';
  const frameFocus = frameType === 'start'
    ? 'åˆå§‹çŠ¶æ€ã€èµ·å§‹å§¿æ€ã€é¢„å¤‡åŠ¨ä½œã€åœºæ™¯å»ºç«‹'
    : 'æœ€ç»ˆçŠ¶æ€ã€ç»“æŸå§¿æ€ã€åŠ¨ä½œå®Œæˆã€æƒ…ç»ªé«˜æ½®';

  const styleDesc = getStylePromptCN(visualStyle);

  const prompt = `
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç”µå½±è§†è§‰å¯¼æ¼”å’Œæ¦‚å¿µè‰ºæœ¯å®¶ã€‚è¯·ä¸ºä»¥ä¸‹é•œå¤´çš„${frameLabel}åˆ›ä½œè¯¦ç»†çš„è§†è§‰æè¿°ã€‚

## åœºæ™¯ä¿¡æ¯
**åœ°ç‚¹ï¼š** ${sceneInfo.location}
**æ—¶é—´ï¼š** ${sceneInfo.time}
**æ°›å›´ï¼š** ${sceneInfo.atmosphere}

## å™äº‹åŠ¨ä½œ
${actionSummary}

## é•œå¤´è¿åŠ¨
${cameraMovement}

## è§’è‰²ä¿¡æ¯
${characterInfo.length > 0 ? characterInfo.join('ã€') : 'æ— ç‰¹å®šè§’è‰²'}

## è§†è§‰é£æ ¼
${styleDesc}

## ä»»åŠ¡è¦æ±‚

ä½œä¸º${frameLabel}ï¼Œä½ éœ€è¦é‡ç‚¹æè¿°ï¼š**${frameFocus}**

### ${frameType === 'start' ? 'èµ·å§‹å¸§' : 'ç»“æŸå¸§'}ç‰¹æ®Šè¦æ±‚ï¼š
${frameType === 'start' ? `
â€¢ å»ºç«‹æ¸…æ™°çš„åˆå§‹åœºæ™¯å’Œäººç‰©çŠ¶æ€
â€¢ ä¸ºå³å°†å‘ç”Ÿçš„åŠ¨ä½œé¢„ç•™è§†è§‰ç©ºé—´å’ŒåŠ¨åŠ¿
â€¢ è®¾å®šå…‰å½±å’Œè‰²è°ƒåŸºè°ƒ
â€¢ å±•ç°è§’è‰²çš„èµ·å§‹è¡¨æƒ…ã€å§¿æ€å’Œä½ç½®
â€¢ æ ¹æ®é•œå¤´è¿åŠ¨ï¼ˆ${cameraMovement}ï¼‰è®¾ç½®åˆé€‚çš„åˆå§‹æ„å›¾
â€¢ è¥é€ åœºæ™¯æ°›å›´ï¼Œè®©è§‚ä¼—æ˜ç¡®æ•…äº‹çš„èµ·ç‚¹
` : `
â€¢ å±•ç°åŠ¨ä½œå®Œæˆåçš„æœ€ç»ˆçŠ¶æ€å’Œç»“æœ
â€¢ ä½“ç°é•œå¤´è¿åŠ¨ï¼ˆ${cameraMovement}ï¼‰å¸¦æ¥çš„è§†è§’å’Œæ„å›¾å˜åŒ–
â€¢ å±•ç°è§’è‰²çš„æƒ…ç»ªå˜åŒ–ã€æœ€ç»ˆå§¿æ€å’Œä½ç½®
â€¢ å¯ä»¥æœ‰æˆå‰§æ€§çš„å…‰å½±å’Œè‰²å½©å˜åŒ–
â€¢ è¾¾åˆ°è§†è§‰é«˜æ½®æˆ–æƒ…ç»ªé‡Šæ”¾ç‚¹
â€¢ ä¸ºä¸‹ä¸€ä¸ªé•œå¤´çš„è¡”æ¥åšå‡†å¤‡
`}

### å¿…é¡»åŒ…å«çš„è§†è§‰å…ƒç´ ï¼š

**1. æ„å›¾ä¸æ™¯åˆ«**
- æ ¹æ®é•œå¤´è¿åŠ¨ç¡®å®šç”»é¢æ¡†æ¶å’Œè§†è§’
- ä¸»ä½“åœ¨ç”»é¢ä¸­çš„ä½ç½®å’Œå¤§å°
- å‰æ™¯ã€ä¸­æ™¯ã€èƒŒæ™¯çš„å±‚æ¬¡å…³ç³»

**2. å…‰å½±ä¸è‰²å½©**
- å…‰æºçš„æ–¹å‘ã€å¼ºåº¦å’Œè‰²æ¸©
- ä¸»å…‰ã€è¾…å…‰ã€è½®å»“å…‰çš„é…ç½®
- æ•´ä½“è‰²è°ƒå’Œè‰²å½©æƒ…ç»ªï¼ˆæš–è‰²/å†·è‰²ï¼‰
- é˜´å½±çš„é•¿åº¦å’Œå¯†åº¦

**3. è§’è‰²ç»†èŠ‚**ï¼ˆå¦‚æœ‰ï¼‰
- é¢éƒ¨è¡¨æƒ…å’Œçœ¼ç¥æ–¹å‘
- è‚¢ä½“å§¿æ€å’Œé‡å¿ƒåˆ†å¸ƒ
- æœè£…çŠ¶æ€å’Œç»†èŠ‚
- ä¸ç¯å¢ƒçš„äº’åŠ¨å…³ç³»

**4. ç¯å¢ƒç»†èŠ‚**
- åœºæ™¯çš„å…·ä½“è§†è§‰å…ƒç´ 
- ç¯å¢ƒæ°›å›´ï¼ˆé›¾æ°”ã€å…‰æŸã€ç²’å­ç­‰ï¼‰
- èƒŒæ™¯çš„æ¸…æ™°åº¦å’Œæ™¯æ·±æ•ˆæœ
- ç¯å¢ƒå¯¹å™äº‹çš„æ”¯æŒ

**5. è¿åŠ¨æš—ç¤º**
- åŠ¨æ€æ¨¡ç³Šæˆ–é™æ­¢æ¸…æ™°
- è¿åŠ¨æ–¹å‘çš„è§†è§‰å¼•å¯¼
- å¼ åŠ›å’ŒåŠ¨åŠ¿çš„ä½“ç°

**6. ç”µå½±æ„Ÿç»†èŠ‚**
- ç”»é¢è´¨æ„Ÿå’Œæè´¨
- å¤§æ°”é€è§†æ•ˆæœ
- ç”µå½±çº§çš„è§†è§‰ç‰¹å¾

## è¾“å‡ºæ ¼å¼

è¯·ç›´æ¥è¾“å‡ºç®€æ´ä½†è¯¦ç»†çš„è§†è§‰æè¿°ï¼Œçº¦100-150å­—ï¼Œç”¨ä¸­æ–‡ã€‚

âŒ é¿å…ï¼š
- ä¸è¦åŒ…å«"Visual Style:"ç­‰æ ‡ç­¾
- ä¸è¦åˆ†æ®µæˆ–ä½¿ç”¨é¡¹ç›®ç¬¦å·
- ä¸è¦è¿‡äºæŠ€æœ¯åŒ–çš„æœ¯è¯­
- ä¸è¦æè¿°æ•´ä¸ªåŠ¨ä½œè¿‡ç¨‹ï¼Œåªæè¿°è¿™ä¸€å¸§çš„ç”»é¢

âœ… è¿½æ±‚ï¼š
- æµç•…çš„å•æ®µæè¿°
- å¯Œæœ‰ç”»é¢æ„Ÿçš„è¯­è¨€
- çªå‡º${frameLabel}çš„ç‰¹ç‚¹
- ä¸å™äº‹åŠ¨ä½œå’Œé•œå¤´è¿åŠ¨åè°ƒä¸€è‡´
- å…·ä½“ã€å¯è§†è§‰åŒ–çš„ç»†èŠ‚

è¯·å¼€å§‹åˆ›ä½œè¿™ä¸€å¸§çš„è§†è§‰æè¿°ï¼š
`;

  try {
    const result = await retryOperation(() => chatCompletion(prompt, model, 0.7, 1024));
    const duration = Date.now() - startTime;

    console.log(`âœ… AI ${frameLabel}ä¼˜åŒ–æˆåŠŸï¼Œè€—æ—¶:`, duration, 'ms');

    return result.trim();
  } catch (error: any) {
    console.error(`âŒ AI ${frameLabel}ä¼˜åŒ–å¤±è´¥:`, error);
    throw new Error(`AI ${frameLabel}ä¼˜åŒ–å¤±è´¥: ${error.message}`);
  }
};

// ============================================
// åŠ¨ä½œç”Ÿæˆ
// ============================================

/**
 * AIç”Ÿæˆå™äº‹åŠ¨ä½œå»ºè®®
 */
export const generateActionSuggestion = async (
  startFramePrompt: string,
  endFramePrompt: string,
  cameraMovement: string,
  model: string = 'gpt-5.1'
): Promise<string> => {
  console.log('ğŸ¬ generateActionSuggestion è°ƒç”¨ - ä½¿ç”¨æ¨¡å‹:', model);
  const startTime = Date.now();

  const actionReferenceExamples = `
## é«˜è´¨é‡åŠ¨ä½œæç¤ºè¯å‚è€ƒç¤ºä¾‹

### ç‰¹æ•ˆé­”æ³•æˆç¤ºä¾‹
ä¸ç”·ç”Ÿé£åœ¨ç©ºä¸­ï¼Œéšç€æŠ¬èµ·æ‰‹è‡‚ï¼Œé•œå¤´è¿…é€Ÿæ‹‰è¿œåˆ°å¤§è¿œæ™¯ï¼Œå¤©ç©ºä¸æ–­åŠˆä¸‹å¯†å¯†éº»éº»çš„é—ªç”µï¼Œç”·ç”Ÿçš„æœºç”²åŒ–ä½œè“å…‰ï¼Œå½¢æˆä¸€ä¸ªå‹è¿«æ„Ÿæ‹‰æ»¡ï¼Œå·¨å¤§çš„é­”æ³•å†²å‘é•œå¤´ï¼Œéœ‡æ’¼æ„Ÿå’Œå‹è¿«æ„Ÿæ‹‰æ»¡ã€‚è¦æ±‚ç”µå½±çº§è¿é•œï¼Œæœ‰å¤šä¸ªé•œå¤´çš„è½¬æ¢ï¼Œå†…å®¹åŠ¨ä½œç¬¦åˆè¦æ±‚ï¼Œè¿é•œè¦æœ‰å¤§ç‰‡çš„æ—¢è§†æ„Ÿï¼ŒåŠ¨ä½œç‚«é…·ä¸”åˆç†ï¼Œè¿…é€Ÿä¸”å¯Œæœ‰å¼ åŠ›ã€‚

### æ‰“æ–—æˆç¤ºä¾‹
é¢å…·äººå’Œç™½å‘ç”·ç”Ÿèµ¤æ‰‹ç©ºæ‹³å±•å¼€è‚‰æï¼Œä»–ä»¬ä¼šä½¿ç”¨é­”æ³•ã€‚è¦æ±‚æ‹¥æœ‰æå°é¾™ã€æˆé¾™çº§åˆ«çš„æ‰“æ–—åŠ¨ä½œã€‚è¦æ±‚ç”µå½±çº§è¿é•œï¼Œæœ‰å¤šä¸ªé•œå¤´çš„è½¬æ¢ï¼Œå†…å®¹åŠ¨ä½œç¬¦åˆè¦æ±‚ï¼Œè¿é•œè¦æœ‰å¤§ç‰‡çš„æ—¢è§†æ„Ÿï¼ŒåŠ¨ä½œç‚«é…·ä¸”åˆç†ï¼Œè¿…é€Ÿä¸”å¯Œæœ‰å¼ åŠ›ã€‚

### è“„åŠ›æ”»å‡»ç¤ºä¾‹
æœºç”²è“„åŠ›ï¼Œæœå¤©ç©ºçŒ›å¼€å‡ ç‚®ï¼Œéœ‡æ’¼æ„Ÿå’Œå‹è¿«æ„Ÿæ‹‰æ»¡ã€‚è¦æ±‚ç”µå½±çº§è¿é•œï¼Œæœ‰å¤šä¸ªé•œå¤´çš„è½¬æ¢ï¼Œå†…å®¹åŠ¨ä½œç¬¦åˆè¦æ±‚ï¼Œè¿é•œè¦æœ‰å¤§ç‰‡çš„æ—¢è§†æ„Ÿï¼ŒåŠ¨ä½œç‚«é…·ä¸”åˆç†ï¼Œè¿…é€Ÿä¸”å¯Œæœ‰å¼ åŠ›ã€‚

### é­”æ³•å±•å¼€ç¤ºä¾‹
ç”·ç”Ÿè„šä¸‹çš„åœ°é¢çªç„¶å‰§çƒˆéœ‡åŠ¨ï¼Œä¸€æ ¹æ ¹ç²—å£®çš„çŸ³åˆºç ´åœŸè€Œå‡ºå¦‚åŒæ€ªå…½çš„ç ç‰™ï¼Œå‹è¿«æ„Ÿæ‹‰æ»¡ï¼Œç–¯ç‹‚åœ°æœä»–åˆºæ¥(ç»™çŸ³åˆºç‰¹å†™)ï¼ç”·ç”Ÿå¿«é€Ÿè·ƒèµ·ï¼ŒåŒæ—¶åŒæ‰‹åœ¨èƒ¸å‰åˆæ‹¢ã€‚çœ¼ç›æ•£å‘å‡ºè“è‰²çš„é­”æ³•å…‰èŠ’ï¼Œå¤§å–Šï¼šé¢†åŸŸå±•å¼€Â·æ— å°½å†°åŸï¼å—¡ï¼ä¸€è‚¡è‚‰çœ¼å¯è§çš„è“è‰²æ³¢çº¹ç¬é—´æ‰©æ•£å¼€æ¥ï¼Œæ‰€è¿‡ä¹‹å¤„ï¼Œæ— è®ºæ˜¯åœ°é¢ã€å¢™å£å…¨éƒ½è¢«ä¸€å±‚åšåšçš„åšå†°è¦†ç›–ï¼æ•´ä¸ªä»“åº“è¿˜æ˜¯åºŸå¼ƒçš„é›†è£…ç®±ï¼Œç¬é—´å˜æˆäº†ä¸€ç‰‡å…‰æ»‘çš„æºœå†°åœºï¼çŸ³åˆºä¹Ÿè¢«å†»ä½ã€‚è¦æ±‚ç”µå½±çº§è¿é•œï¼Œæœ‰å¤šä¸ªé•œå¤´çš„è½¬æ¢ï¼Œå†…å®¹åŠ¨ä½œç¬¦åˆè¦æ±‚ï¼Œè¿é•œè¦æœ‰å¤§ç‰‡çš„æ—¢è§†æ„Ÿï¼ŒåŠ¨ä½œç‚«é…·ä¸”åˆç†ï¼Œè¿…é€Ÿä¸”å¯Œæœ‰å¼ åŠ›ã€‚

### å¿«é€Ÿç§»åŠ¨ç¤ºä¾‹
é•œå¤´1ï¼šå¤©å°å·¦ä¾§ä¸­æ™¯ï¼Œéƒ‘ä¸€å‰‘åˆå§‹ç«™ç«‹ï¼ŒèƒŒåæ˜¯å¤œè‰²ç¬¼ç½©ä¸‹ç¯ç«é—ªçƒçš„åŸå¸‚ï¼Œåœ†æœˆé«˜æ‚¬ã€‚ä»–ä¿æŒç€ä¸€ç§è“„åŠ¿å¾…å‘çš„é™æ€ç«™ç«‹å§¿æ€ï¼Œå‘¨èº«æ°›å›´æ²‰é™ã€‚
é•œå¤´2ï¼šéƒ‘ä¸€å‰‘æ¶ˆå¤±ï¼š"æ¨¡ç³Šæ‹–å½±"ç‰¹æ•ˆä¸ç©ºæ°”æ‰°åŠ¨ï¼Œç”»é¢ç¬é—´è§¦å‘"æ¨¡ç³Šæ‹–å½±"ç‰¹æ•ˆï¼Œèº«å½±å¦‚è¢«å¿«é€Ÿæ‹‰æ‰¯çš„å¹»å½±èˆ¬ï¼Œä»¥æå¿«çš„é€Ÿåº¦æ·¡åŒ–ã€æ¶ˆå¤±ï¼ŒåŸåœ°åªæ®‹ç•™æå…¶è½»å¾®çš„ç©ºæ°”æ‰°åŠ¨æ³¢çº¹ã€‚
é•œå¤´3ï¼šé•œå¤´æ€¥é€Ÿç§»è‡³æ›²é£é¢å‰ï¼Œä»éƒ‘ä¸€å‰‘æ¶ˆå¤±çš„ä½ç½®ï¼Œä»¥è¿…çŒ›çš„é€Ÿåº¦æ¨ªå‘ç§»åŠ¨ï¼Œç”»é¢é‡Œå¤©å°çš„æ æ†ã€åœ°é¢ç­‰æ™¯ç‰©é£é€Ÿæ è¿‡ï¼Œäº§ç”Ÿå¼ºçƒˆçš„åŠ¨æ€æ¨¡ç³Šæ•ˆæœã€‚æœ€ç»ˆé•œå¤´å®šæ ¼åœ¨æ›²é£é¢å‰ï¼Œè„¸ä¸Šéœ²å‡ºæ˜æ˜¾çš„æƒŠè®¶ä¸è­¦æƒ•ã€‚
é•œå¤´4ï¼šéƒ‘ä¸€å‰‘çªç„¶å‡ºç°å‡†å¤‡å‡ºæ‹³ï¼Œæ¯«æ— å¾å…†åœ°å‡ºç°åœ¨ç”»é¢ä¸­å¤®ï¼Œèº«ä½“å¤§å¹…åº¦å‰å€¾ï¼Œå‘ˆç°å‡ºæå…·å¼ åŠ›çš„å‡†å¤‡å‡ºæ‹³å§¿åŠ¿ï¼Œå³æ‰‹ç´§ç´§æ¡æ‹³ï¼Œå¸¦èµ·çš„åŠ²é£ä½¿å¾—è¡£è§’å¤§å¹…åº¦å‘åé£˜åŠ¨ã€‚

### èƒ½é‡çˆ†å‘ç¤ºä¾‹
é•œå¤´åœ¨å€¾ç›†å¤§é›¨ä¸­å¿«é€ŸæŠ–åŠ¨å‘å‰æ¨è¿›ï¼Œå¯¹å‡†åœ¨é»‘æš—æµ·å¹³é¢ä¸­å±¹ç«‹ä¸åŠ¨çš„é»‘å½±ã€‚å‡ é“é—ªç”µå¿«é€Ÿåˆ’è¿‡ï¼Œè½®å»“åœ¨é›¨å¹•ä¸­è‹¥éšè‹¥ç°ã€‚çªç„¶ï¼Œä¸€è‚¡å·¨å¤§çš„é›·æš´èƒ½é‡åœ¨ä»–èº«åå¿«é€Ÿæ±‡èšï¼Œå…‰èŠ’çŒ›çƒˆçˆ†å‘ã€‚é•œå¤´ç«‹åˆ»å¿«é€Ÿå‘åœ°é¢çŒ›å†²ï¼Œå¹¶åŒæ—¶å‘ä¸Šæåº¦ä»°èµ·ï¼Œé”å®šä»–è¢«èƒ½é‡å…‰èŠ’å®Œå…¨ç…§äº®çš„ã€å¼ å¼€åŒè‡‚çš„å¨ä¸¥å§¿æ€ã€‚
`;

  const prompt = `
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç”µå½±åŠ¨ä½œå¯¼æ¼”å’Œå™äº‹é¡¾é—®ã€‚è¯·æ ¹æ®æä¾›çš„é¦–å¸§å’Œå°¾å¸§ä¿¡æ¯ï¼Œç»“åˆé•œå¤´è¿åŠ¨ï¼Œè®¾è®¡ä¸€ä¸ªæ—¢ç¬¦åˆå™äº‹é€»è¾‘åˆå……æ»¡è§†è§‰å†²å‡»åŠ›çš„åŠ¨ä½œåœºæ™¯ã€‚

## é‡è¦çº¦æŸ
â±ï¸ **æ—¶é•¿é™åˆ¶**ï¼šè¿™æ˜¯ä¸€ä¸ª8-10ç§’çš„å•é•œå¤´åœºæ™¯ï¼Œè¯·ä¸¥æ ¼æ§åˆ¶åŠ¨ä½œå¤æ‚åº¦
ğŸ“¹ **é•œå¤´è¦æ±‚**ï¼šè¿™æ˜¯ä¸€ä¸ªè¿ç»­é•œå¤´ï¼Œä¸è¦è®¾è®¡å¤šä¸ªé•œå¤´åˆ‡æ¢ï¼ˆé™¤éç»å¯¹å¿…è¦ï¼Œæœ€å¤š2-3ä¸ªå¿«é€Ÿåˆ‡æ¢ï¼‰

## è¾“å…¥ä¿¡æ¯
**é¦–å¸§æè¿°ï¼š** ${startFramePrompt}
**å°¾å¸§æè¿°ï¼š** ${endFramePrompt}
**é•œå¤´è¿åŠ¨ï¼š** ${cameraMovement}

${actionReferenceExamples}

## ä»»åŠ¡è¦æ±‚
1. **æ—¶é•¿é€‚é…**ï¼šåŠ¨ä½œè®¾è®¡å¿…é¡»åœ¨8-10ç§’å†…å®Œæˆï¼Œé¿å…è¿‡äºå¤æ‚çš„å¤šæ­¥éª¤åŠ¨ä½œ
2. **å•é•œå¤´æ€ç»´**ï¼šä¼˜å…ˆè®¾è®¡ä¸€ä¸ªè¿è´¯çš„é•œå¤´å†…åŠ¨ä½œï¼Œè€Œéå¤šé•œå¤´ç»„åˆ
3. **è‡ªç„¶è¡”æ¥**ï¼šåŠ¨ä½œéœ€è¦è‡ªç„¶åœ°ä»é¦–å¸§è¿‡æ¸¡åˆ°å°¾å¸§ï¼Œç¡®ä¿é€»è¾‘åˆç†
4. **é£æ ¼å€Ÿé‰´**ï¼šå‚è€ƒä¸Šè¿°ç¤ºä¾‹çš„é£æ ¼å’Œè¯­è¨€ï¼Œä½†è¦ç®€åŒ–æ­¥éª¤ï¼š
   - å¯Œæœ‰å¼ åŠ›ä½†ç®€æ´çš„æè¿°è¯­è¨€
   - å¼ºè°ƒå…³é”®çš„è§†è§‰å†²å‡»ç‚¹
   - ç”µå½±çº§çš„è¿é•œæè¿°ä½†é¿å…è¿‡åº¦åˆ†è§£
5. **åˆ›æ–°é€‚é…**ï¼šä¸è¦é‡å¤å·²æœ‰æç¤ºè¯ï¼Œç»“åˆå½“å‰åœºæ™¯åˆ›æ–°
6. **é•œå¤´è¯­è¨€**ï¼šæ ¹æ®æä¾›çš„é•œå¤´è¿åŠ¨ï¼ˆ${cameraMovement}ï¼‰ï¼Œè®¾è®¡ç›¸åº”çš„è¿é•œæ–¹æ¡ˆ

## è¾“å‡ºæ ¼å¼
è¯·ç›´æ¥è¾“å‡ºåŠ¨ä½œæè¿°æ–‡æœ¬ï¼Œæ— éœ€JSONæ ¼å¼æˆ–é¢å¤–æ ‡è®°ã€‚å†…å®¹åº”åŒ…å«ï¼š
- ç®€æ´çš„å•é•œå¤´åŠ¨ä½œåœºæ™¯æè¿°ï¼ˆä¸è¦"é•œå¤´1ã€é•œå¤´2..."çš„åˆ†æ®µï¼Œé™¤éåœºæ™¯ç¡®å®éœ€è¦å¿«é€Ÿåˆ‡æ¢ï¼‰
- å…³é”®çš„è¿é•œè¯´æ˜ï¼ˆæ¨æ‹‰æ‘‡ç§»ç­‰ï¼‰
- æ ¸å¿ƒçš„è§†è§‰ç‰¹æ•ˆæˆ–æƒ…æ„Ÿæ°›å›´
- ç¡®ä¿æè¿°å…·æœ‰ç”µå½±æ„Ÿä½†æ§åˆ¶ç¯‡å¹…

âŒ é¿å…ï¼šè¿‡å¤šçš„é•œå¤´åˆ‡æ¢ã€å†—é•¿çš„åˆ†æ­¥æè¿°ã€è¶…è¿‡10ç§’çš„å¤æ‚åŠ¨ä½œåºåˆ—
âœ… è¿½æ±‚ï¼šç²¾ç‚¼ã€æœ‰å†²å‡»åŠ›ã€ç¬¦åˆ8-10ç§’æ—¶é•¿çš„å•é•œå¤´åŠ¨ä½œ

è¯·å¼€å§‹åˆ›ä½œï¼š
`;

  try {
    const result = await retryOperation(() => chatCompletion(prompt, model, 0.8, 2048));
    const duration = Date.now() - startTime;

    console.log('âœ… AIåŠ¨ä½œç”ŸæˆæˆåŠŸï¼Œè€—æ—¶:', duration, 'ms');

    return result.trim();
  } catch (error: any) {
    console.error('âŒ AIåŠ¨ä½œç”Ÿæˆå¤±è´¥:', error);
    throw new Error(`AIåŠ¨ä½œç”Ÿæˆå¤±è´¥: ${error.message}`);
  }
};

// ============================================
// é•œå¤´æ‹†åˆ†
// ============================================

/**
 * AIé•œå¤´æ‹†åˆ†åŠŸèƒ½ - å°†å•ä¸ªé•œå¤´æ‹†åˆ†ä¸ºå¤šä¸ªç»†è‡´çš„å­é•œå¤´
 */
export const splitShotIntoSubShots = async (
  shot: any,
  sceneInfo: { location: string; time: string; atmosphere: string },
  characterNames: string[],
  visualStyle: string,
  model: string = 'gpt-5.1'
): Promise<{ subShots: any[] }> => {
  console.log('âœ‚ï¸ splitShotIntoSubShots è°ƒç”¨ - ä½¿ç”¨æ¨¡å‹:', model);
  const startTime = Date.now();

  const styleDesc = getStylePromptCN(visualStyle);

  const prompt = `
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç”µå½±åˆ†é•œå¸ˆå’Œå¯¼æ¼”ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†ä¸€ä¸ªç²—ç•¥çš„é•œå¤´æè¿°ï¼Œæ‹†åˆ†ä¸ºå¤šä¸ªç»†è‡´ã€ä¸“ä¸šçš„å­é•œå¤´ã€‚

## åŸå§‹é•œå¤´ä¿¡æ¯

**åœºæ™¯åœ°ç‚¹ï¼š** ${sceneInfo.location}
**åœºæ™¯æ—¶é—´ï¼š** ${sceneInfo.time}
**åœºæ™¯æ°›å›´ï¼š** ${sceneInfo.atmosphere}
**è§’è‰²ï¼š** ${characterNames.length > 0 ? characterNames.join('ã€') : 'æ— ç‰¹å®šè§’è‰²'}
**è§†è§‰é£æ ¼ï¼š** ${styleDesc}
**åŸå§‹é•œå¤´è¿åŠ¨ï¼š** ${shot.cameraMovement || 'æœªæŒ‡å®š'}

**åŸå§‹åŠ¨ä½œæè¿°ï¼š**
${shot.actionSummary}

${shot.dialogue ? `**å¯¹ç™½ï¼š** "${shot.dialogue}"

âš ï¸ **å¯¹ç™½å¤„ç†è¯´æ˜**ï¼šåŸå§‹é•œå¤´åŒ…å«å¯¹ç™½ã€‚è¯·åœ¨æ‹†åˆ†æ—¶ï¼Œå°†å¯¹ç™½æ”¾åœ¨æœ€åˆé€‚çš„å­é•œå¤´ä¸­ï¼ˆé€šå¸¸æ˜¯è§’è‰²è¯´è¯çš„ä¸­æ™¯æˆ–è¿‘æ™¯é•œå¤´ï¼‰ï¼Œå¹¶åœ¨è¯¥å­é•œå¤´çš„actionSummaryä¸­æ˜ç¡®æåŠå¯¹ç™½å†…å®¹ã€‚å…¶ä»–å­é•œå¤´ä¸éœ€è¦åŒ…å«å¯¹ç™½ã€‚` : ''}

## æ‹†åˆ†è¦æ±‚

### æ ¸å¿ƒåŸåˆ™
1. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªå­é•œå¤´åªè´Ÿè´£ä¸€ä¸ªè§†è§’æˆ–åŠ¨ä½œç»†èŠ‚ï¼Œé¿å…æ··åˆå¤šä¸ªè§†è§’
2. **æ—¶é•¿æ§åˆ¶**ï¼šæ¯ä¸ªå­é•œå¤´æ—¶é•¿çº¦2-4ç§’ï¼Œæ€»æ—¶é•¿ä¿æŒåœ¨8-10ç§’å·¦å³
3. **æ™¯åˆ«å¤šæ ·åŒ–**ï¼šåˆç†è¿ç”¨å…¨æ™¯ã€ä¸­æ™¯ã€ç‰¹å†™ç­‰ä¸åŒæ™¯åˆ«
4. **è¿è´¯æ€§**ï¼šå­é•œå¤´ä¹‹é—´è¦æœ‰é€»è¾‘çš„è§†è§‰è¿‡æ¸¡å’Œå™äº‹è¿è´¯æ€§

### æ‹†åˆ†ç»´åº¦ç¤ºä¾‹

**æ™¯åˆ«åˆ†ç±»ï¼ˆShot Sizeï¼‰ï¼š**
- **è¿œæ™¯ Long Shot / å…¨æ™¯ Wide Shot**ï¼šå±•ç¤ºæ•´ä½“ç¯å¢ƒã€äººç‰©ä½ç½®å…³ç³»ã€ç©ºé—´å¸ƒå±€
- **ä¸­æ™¯ Medium Shot**ï¼šå±•ç¤ºäººç‰©ä¸ŠåŠèº«æˆ–è…°éƒ¨ä»¥ä¸Šï¼Œå¼ºè°ƒåŠ¨ä½œå’Œè¡¨æƒ…
- **è¿‘æ™¯ Close-up**ï¼šå±•ç¤ºäººç‰©å¤´éƒ¨æˆ–é‡è¦ç‰©ä½“ï¼Œå¼ºè°ƒæƒ…æ„Ÿå’Œç»†èŠ‚
- **ç‰¹å†™ Extreme Close-up**ï¼šèšç„¦å…³é”®ç»†èŠ‚ï¼ˆå¦‚æ‰‹éƒ¨åŠ¨ä½œã€çœ¼ç¥ã€ç‰©ä½“ç‰¹å†™ï¼‰

### å¿…é¡»åŒ…å«çš„å­—æ®µ

æ¯ä¸ªå­é•œå¤´å¿…é¡»åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **shotSize**ï¼ˆæ™¯åˆ«ï¼‰ï¼šæ˜ç¡®æ ‡æ³¨æ™¯åˆ«ç±»å‹
2. **cameraMovement**ï¼ˆé•œå¤´è¿åŠ¨ï¼‰ï¼šæè¿°é•œå¤´å¦‚ä½•ç§»åŠ¨
3. **actionSummary**ï¼ˆåŠ¨ä½œæè¿°ï¼‰ï¼šæ¸…æ™°ã€å…·ä½“çš„åŠ¨ä½œå’Œç”»é¢å†…å®¹æè¿°ï¼ˆ60-100å­—ï¼‰
4. **visualFocus**ï¼ˆè§†è§‰ç„¦ç‚¹ï¼‰ï¼šè¿™ä¸ªé•œå¤´çš„è§†è§‰é‡ç‚¹
5. **keyframes**ï¼ˆå…³é”®å¸§æ•°ç»„ï¼‰ï¼šåŒ…å«èµ·å§‹å¸§(start)å’Œç»“æŸå¸§(end)çš„è§†è§‰æè¿°

### ä¸“ä¸šé•œå¤´è¿åŠ¨å‚è€ƒ
- é™æ­¢é•œå¤´ Static Shot
- æ¨é•œå¤´ Dolly Shot / æ‹‰é•œå¤´ Zoom Out
- è·Ÿè¸ªé•œå¤´ Tracking Shot
- å¹³ç§»é•œå¤´ Pan Shot
- ç¯ç»•é•œå¤´ Circular Shot
- ä¿¯è§†é•œå¤´ High Angle / ä»°è§†é•œå¤´ Low Angle
- ä¸»è§‚è§†è§’ POV Shot
- è¶Šè‚©é•œå¤´ Over the Shoulder

## è¾“å‡ºæ ¼å¼

è¯·è¾“å‡ºJSONæ ¼å¼ï¼Œç»“æ„å¦‚ä¸‹ï¼š

\`\`\`json
{
  "subShots": [
    {
      "shotSize": "å…¨æ™¯ Wide Shot",
      "cameraMovement": "é™æ­¢é•œå¤´ Static Shot",
      "actionSummary": "åŠ¨ä½œæè¿°...",
      "visualFocus": "è§†è§‰ç„¦ç‚¹æè¿°",
      "keyframes": [
        {
          "type": "start",
          "visualPrompt": "èµ·å§‹å¸§è§†è§‰æè¿°ï¼Œ${styleDesc}ï¼Œ100-150å­—..."
        },
        {
          "type": "end",
          "visualPrompt": "ç»“æŸå¸§è§†è§‰æè¿°ï¼Œ${styleDesc}ï¼Œ100-150å­—..."
        }
      ]
    }
  ]
}
\`\`\`

**å…³é”®å¸§visualPromptè¦æ±‚**ï¼š
- å¿…é¡»åŒ…å«è§†è§‰é£æ ¼æ ‡è®°ï¼ˆ${styleDesc}ï¼‰
- è¯¦ç»†æè¿°ç”»é¢æ„å›¾ã€å…‰å½±ã€è‰²å½©ã€æ™¯æ·±ç­‰è§†è§‰å…ƒç´ 
- èµ·å§‹å¸§å’Œç»“æŸå¸§è¦æœ‰æ˜æ˜¾çš„è§†è§‰å·®å¼‚
- é•¿åº¦æ§åˆ¶åœ¨100-150å­—

## é‡è¦æç¤º

âŒ **é¿å…ï¼š**
- ä¸è¦åœ¨å•ä¸ªå­é•œå¤´ä¸­æ··åˆå¤šä¸ªè§†è§’æˆ–æ™¯åˆ«
- ä¸è¦æ‹†åˆ†è¿‡ç»†å¯¼è‡´æ€»æ—¶é•¿è¶…è¿‡10ç§’
- ä¸è¦å¿½ç•¥è§†è§‰è¿è´¯æ€§

âœ… **è¿½æ±‚ï¼š**
- æ¯ä¸ªå­é•œå¤´èŒè´£æ¸…æ™°ã€ç”»é¢æ„Ÿå¼º
- æ™¯åˆ«å’Œè§†è§’å¤šæ ·åŒ–ä½†ç¬¦åˆå™äº‹é€»è¾‘
- ä¿æŒç”µå½±çº§çš„ä¸“ä¸šè¡¨è¾¾

è¯·å¼€å§‹æ‹†åˆ†ï¼Œç›´æ¥è¾“å‡ºJSONæ ¼å¼ï¼ˆä¸è¦åŒ…å«markdownä»£ç å—æ ‡è®°ï¼‰ï¼š
`;

  try {
    const result = await retryOperation(() => chatCompletion(prompt, model, 0.7, 4096, 'json_object'));
    const duration = Date.now() - startTime;

    const cleaned = cleanJsonString(result);
    const parsed = JSON.parse(cleaned);

    if (!parsed.subShots || !Array.isArray(parsed.subShots) || parsed.subShots.length === 0) {
      throw new Error('AIè¿”å›çš„JSONæ ¼å¼ä¸æ­£ç¡®æˆ–å­é•œå¤´æ•°ç»„ä¸ºç©º');
    }

    // éªŒè¯æ¯ä¸ªå­é•œå¤´
    for (const subShot of parsed.subShots) {
      if (!subShot.shotSize || !subShot.cameraMovement || !subShot.actionSummary || !subShot.visualFocus) {
        throw new Error('å­é•œå¤´ç¼ºå°‘å¿…éœ€å­—æ®µï¼ˆshotSizeã€cameraMovementã€actionSummaryã€visualFocusï¼‰');
      }
      if (!subShot.keyframes || !Array.isArray(subShot.keyframes) || subShot.keyframes.length === 0) {
        throw new Error('å­é•œå¤´ç¼ºå°‘å…³é”®å¸§æ•°ç»„ï¼ˆkeyframesï¼‰');
      }
      for (const kf of subShot.keyframes) {
        if (!kf.type || !kf.visualPrompt) {
          throw new Error('å…³é”®å¸§ç¼ºå°‘å¿…éœ€å­—æ®µï¼ˆtypeã€visualPromptï¼‰');
        }
        if (kf.type !== 'start' && kf.type !== 'end') {
          throw new Error('å…³é”®å¸§typeå¿…é¡»æ˜¯"start"æˆ–"end"');
        }
      }
    }

    console.log(`âœ… é•œå¤´æ‹†åˆ†æˆåŠŸï¼Œç”Ÿæˆ ${parsed.subShots.length} ä¸ªå­é•œå¤´ï¼Œè€—æ—¶:`, duration, 'ms');

    addRenderLogWithTokens({
      type: 'script-parsing',
      resourceId: `shot-split-${shot.id}-${Date.now()}`,
      resourceName: `é•œå¤´æ‹†åˆ† - ${shot.actionSummary.substring(0, 30)}...`,
      status: 'success',
      model: model,
      prompt: prompt.substring(0, 200) + '...',
      duration: duration
    });

    return parsed;
  } catch (error: any) {
    console.error('âŒ é•œå¤´æ‹†åˆ†å¤±è´¥:', error);

    addRenderLogWithTokens({
      type: 'script-parsing',
      resourceId: `shot-split-${shot.id}-${Date.now()}`,
      resourceName: `é•œå¤´æ‹†åˆ† - ${shot.actionSummary.substring(0, 30)}...`,
      status: 'failed',
      model: model,
      prompt: prompt.substring(0, 200) + '...',
      error: error.message,
      duration: Date.now() - startTime
    });

    throw new Error(`é•œå¤´æ‹†åˆ†å¤±è´¥: ${error.message}`);
  }
};

// ============================================
// å…³é”®å¸§å¢å¼º
// ============================================

/**
 * AIå¢å¼ºå…³é”®å¸§æç¤ºè¯ - æ·»åŠ è¯¦ç»†çš„æŠ€æœ¯è§„æ ¼å’Œè§†è§‰ç»†èŠ‚
 */
export const enhanceKeyframePrompt = async (
  basePrompt: string,
  visualStyle: string,
  cameraMovement: string,
  frameType: 'start' | 'end',
  model: string = 'gpt-5.1'
): Promise<string> => {
  console.log(`ğŸ¨ enhanceKeyframePrompt è°ƒç”¨ - ${frameType === 'start' ? 'èµ·å§‹å¸§' : 'ç»“æŸå¸§'} - ä½¿ç”¨æ¨¡å‹:`, model);
  const startTime = Date.now();

  const styleDesc = getStylePromptCN(visualStyle);
  const frameLabel = frameType === 'start' ? 'èµ·å§‹å¸§' : 'ç»“æŸå¸§';

  const prompt = `
ä½ æ˜¯ä¸€ä½èµ„æ·±çš„ç”µå½±æ‘„å½±æŒ‡å¯¼å’Œè§†è§‰ç‰¹æ•ˆä¸“å®¶ã€‚è¯·åŸºäºä»¥ä¸‹åŸºç¡€æç¤ºè¯,ç”Ÿæˆä¸€ä¸ªåŒ…å«è¯¦ç»†æŠ€æœ¯è§„æ ¼å’Œè§†è§‰ç»†èŠ‚çš„ä¸“ä¸šçº§${frameLabel}æè¿°ã€‚

## åŸºç¡€æç¤ºè¯
${basePrompt}

## è§†è§‰é£æ ¼
${styleDesc}

## é•œå¤´è¿åŠ¨
${cameraMovement}

## ${frameLabel}è¦æ±‚
${frameType === 'start' ? 'å»ºç«‹æ¸…æ™°çš„åˆå§‹çŠ¶æ€ã€èµ·å§‹å§¿æ€ã€ä¸ºåç»­è¿åŠ¨é¢„ç•™ç©ºé—´' : 'å±•ç°æœ€ç»ˆçŠ¶æ€ã€åŠ¨ä½œå®Œæˆã€æƒ…ç»ªé«˜æ½®'}

## ä»»åŠ¡
è¯·åœ¨åŸºç¡€æç¤ºè¯çš„åŸºç¡€ä¸Š,æ·»åŠ ä»¥ä¸‹ä¸“ä¸šçš„ç”µå½±çº§è§†è§‰è§„æ ¼æè¿°:

### 1. æŠ€æœ¯è§„æ ¼ (Technical Specifications)
- åˆ†è¾¨ç‡è§„æ ¼ (8Kç­‰)
- é•œå¤´è¯­è¨€å’Œæ‘„å½±ç¾å­¦
- æ™¯æ·±æ§åˆ¶å’Œç„¦ç‚¹ç­–ç•¥

### 2. è§†è§‰ç»†èŠ‚ (Visual Details)  
- å…‰å½±å±‚æ¬¡: ä¸‰ç‚¹å¸ƒå…‰ã€é˜´å½±ä¸é«˜å…‰çš„é…ç½®
- è‰²å½©é¥±å’Œåº¦: è‰²å½©åˆ†çº§ã€è‰²æ¸©æ§åˆ¶
- æè´¨è´¨æ„Ÿ: è¡¨é¢çº¹ç†ã€ç»†èŠ‚ä¸°å¯Œåº¦
- å¤§æ°”æ•ˆæœ: ä½“ç§¯å…‰ã€é›¾æ°”ã€ç²’å­ã€å¤©æ°”æ•ˆæœ

### 3. è§’è‰²è¦æ±‚ (Character Details) - å¦‚æœæœ‰è§’è‰²
âš ï¸ æœ€é«˜ä¼˜å…ˆçº§: å¦‚æœæä¾›äº†è§’è‰²å‚è€ƒå›¾,å¿…é¡»ä¸¥æ ¼ä¿æŒäººç‰©å¤–è§‚çš„å®Œå…¨ä¸€è‡´æ€§!
- é¢éƒ¨è¡¨æƒ…: åœ¨ä¿æŒå¤–è§‚ä¸€è‡´çš„åŸºç¡€ä¸Š,æ·»åŠ å¾®è¡¨æƒ…ã€æƒ…ç»ªçœŸå®åº¦ã€çœ¼ç¥æ–¹å‘
- è‚¢ä½“è¯­è¨€: åœ¨ä¿æŒä½“å‹ä¸€è‡´çš„åŸºç¡€ä¸Š,å±•ç°è‡ªç„¶çš„èº«ä½“å§¿æ€ã€é‡å¿ƒåˆ†å¸ƒã€è‚Œè‚‰å¼ åŠ›
- æœè£…ç»†èŠ‚: æœè£…çš„è¿åŠ¨æ„Ÿã€ç‰©ç†çœŸå®æ€§ã€çº¹ç†ç»†èŠ‚
- æ¯›å‘ç»†èŠ‚: å¤´å‘ä¸ã€è‡ªç„¶çš„æ¯›å‘è¿åŠ¨

### 4. ç¯å¢ƒè¦æ±‚ (Environment Details)
- èƒŒæ™¯å±‚æ¬¡: å‰æ™¯ã€ä¸­æ™¯ã€èƒŒæ™¯çš„æ·±åº¦åˆ†ç¦»
- ç©ºé—´é€è§†: å‡†ç¡®çš„çº¿æ€§é€è§†ã€å¤§æ°”é€è§†
- ç¯å¢ƒå…‰å½±: å…‰æºçš„çœŸå®æ€§ã€é˜´å½±æŠ•å°„
- ç»†èŠ‚ä¸°å¯Œåº¦: ç¯å¢ƒå™äº‹å…ƒç´ ã€çº¹ç†å˜åŒ–

### 5. æ°›å›´è¥é€  (Mood & Atmosphere)
- æƒ…ç»ªåŸºè°ƒä¸åœºæ™¯æƒ…æ„Ÿçš„åŒ¹é…
- è‰²å½©å¿ƒç†å­¦çš„è¿ç”¨
- è§†è§‰èŠ‚å¥çš„å¹³è¡¡
- å™äº‹çš„è§†è§‰æš—ç¤º

### 6. è´¨é‡ä¿è¯ (Quality Assurance)
- ä¸»ä½“æ¸…æ™°åº¦å’Œè½®å»“
- èƒŒæ™¯è¿‡æ¸¡çš„è‡ªç„¶æ€§
- å…‰å½±ä¸€è‡´æ€§
- è‰²å½©åè°ƒæ€§
- æ„å›¾å¹³è¡¡(ä¸‰åˆ†æ³•æˆ–é»„é‡‘æ¯”ä¾‹)
- åŠ¨ä½œè¿è´¯æ€§

## è¾“å‡ºæ ¼å¼
è¯·ä½¿ç”¨æ¸…æ™°çš„åˆ†èŠ‚æ ¼å¼è¾“å‡º,åŒ…å«ä¸Šè¿°æ‰€æœ‰è¦ç´ ã€‚ä½¿ç”¨ä¸­æ–‡è¾“å‡º,ä¿æŒä¸“ä¸šæ€§å’Œå¯è¯»æ€§ã€‚

æ ¼å¼ç¤ºä¾‹:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€æŠ€æœ¯è§„æ ¼ã€‘Technical Specifications
â€¢ åˆ†è¾¨ç‡: ...

ã€è§†è§‰ç»†èŠ‚ã€‘Visual Details  
â€¢ å…‰å½±å±‚æ¬¡: ...
â€¢ è‰²å½©é¥±å’Œåº¦: ...

(ä¾æ¬¡ç±»æ¨)

è¯·å¼€å§‹åˆ›ä½œ:
`;

  try {
    const result = await retryOperation(() => chatCompletion(prompt, model, 0.7, 3072));
    const duration = Date.now() - startTime;

    console.log(`âœ… AI ${frameLabel}å¢å¼ºæˆåŠŸï¼Œè€—æ—¶:`, duration, 'ms');

    return `${basePrompt}

${result.trim()}`;
  } catch (error: any) {
    console.error(`âŒ AI ${frameLabel}å¢å¼ºå¤±è´¥:`, error);
    console.warn('âš ï¸ å›é€€åˆ°åŸºç¡€æç¤ºè¯');
    return basePrompt;
  }
};

// ============================================
// ä¹å®«æ ¼åˆ†é•œé¢„è§ˆ
// ============================================

/**
 * ä½¿ç”¨ Chat æ¨¡å‹å°†é•œå¤´åŠ¨ä½œæ‹†åˆ†ä¸º 9 ä¸ªä¸åŒçš„æ‘„å½±è§†è§’
 */
export const generateNineGridPanels = async (
  actionSummary: string,
  cameraMovement: string,
  sceneInfo: { location: string; time: string; atmosphere: string },
  characterNames: string[],
  visualStyle: string,
  model?: string
): Promise<NineGridPanel[]> => {
  const startTime = Date.now();
  console.log('ğŸ¬ ä¹å®«æ ¼åˆ†é•œ - å¼€å§‹AIæ‹†åˆ†è§†è§’...');

  const resolvedModel = model || getActiveChatModel()?.id || 'gpt-5.1';

  const systemPrompt = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç”µå½±åˆ†é•œå¸ˆå’Œæ‘„å½±æŒ‡å¯¼ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†ä¸€ä¸ªé•œå¤´åŠ¨ä½œæ‹†è§£ä¸º9ä¸ªä¸åŒçš„æ‘„å½±è§†è§’ï¼Œç”¨äºä¹å®«æ ¼åˆ†é•œé¢„è§ˆã€‚
æ¯ä¸ªè§†è§’å¿…é¡»å±•ç¤ºç›¸åŒåœºæ™¯çš„ä¸åŒæ™¯åˆ«å’Œæœºä½è§’åº¦ç»„åˆï¼Œç¡®ä¿è¦†ç›–ä»è¿œæ™¯åˆ°ç‰¹å†™ã€ä»ä¿¯æ‹åˆ°ä»°æ‹çš„å¤šæ ·åŒ–è§†è§’ã€‚`;

  const userPrompt = `è¯·å°†ä»¥ä¸‹é•œå¤´åŠ¨ä½œæ‹†è§£ä¸º9ä¸ªä¸åŒçš„æ‘„å½±è§†è§’ï¼Œç”¨äºç”Ÿæˆä¸€å¼ 3x3ä¹å®«æ ¼åˆ†é•œå›¾ã€‚

ã€é•œå¤´åŠ¨ä½œã€‘${actionSummary}
ã€åŸå§‹é•œå¤´è¿åŠ¨ã€‘${cameraMovement}
ã€åœºæ™¯ä¿¡æ¯ã€‘åœ°ç‚¹: ${sceneInfo.location}, æ—¶é—´: ${sceneInfo.time}, æ°›å›´: ${sceneInfo.atmosphere}
ã€è§’è‰²ã€‘${characterNames.length > 0 ? characterNames.join('ã€') : 'æ— ç‰¹å®šè§’è‰²'}
ã€è§†è§‰é£æ ¼ã€‘${visualStyle}

è¯·æŒ‰ç…§ä»¥ä¸‹è¦æ±‚è¿”å›JSONæ ¼å¼æ•°æ®ï¼š
1. 9ä¸ªè§†è§’å¿…é¡»è¦†ç›–ä¸åŒçš„æ™¯åˆ«å’Œè§’åº¦ç»„åˆï¼Œé¿å…é‡å¤
2. å»ºè®®è¦†ç›–ï¼šå»ºç«‹é•œå¤´(è¿œ/å…¨æ™¯)ã€äººç‰©äº¤äº’(ä¸­æ™¯)ã€æƒ…ç»ªè¡¨è¾¾(è¿‘æ™¯/ç‰¹å†™)ã€æ°›å›´ç»†èŠ‚(å„ç§è§’åº¦)
3. æ¯ä¸ªè§†è§’çš„descriptionå¿…é¡»åŒ…å«å…·ä½“çš„ç”»é¢å†…å®¹æè¿°ï¼ˆè§’è‰²ä½ç½®ã€åŠ¨ä½œã€è¡¨æƒ…ã€ç¯å¢ƒç»†èŠ‚ç­‰ï¼‰
4. descriptionä½¿ç”¨è‹±æ–‡æ’°å†™ï¼Œä½†å¯ä»¥åŒ…å«åœºæ™¯å’Œè§’è‰²çš„ä¸­æ–‡åç§°

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼Œä¸è¦åŒ…å«å…¶ä»–æ–‡å­—ï¼š
{
  "panels": [
    {
      "index": 0,
      "shotSize": "è¿œæ™¯",
      "cameraAngle": "ä¿¯æ‹",
      "description": "Establishing aerial shot showing..."
    },
    {
      "index": 1,
      "shotSize": "ä¸­æ™¯",
      "cameraAngle": "å¹³è§†",
      "description": "Medium shot at eye level..."
    }
  ]
}

æ³¨æ„ï¼šå¿…é¡»æ°å¥½è¿”å›9ä¸ªpanelï¼ˆindex 0-8ï¼‰ï¼ŒæŒ‰ç…§ä¹å®«æ ¼ä»å·¦åˆ°å³ã€ä»ä¸Šåˆ°ä¸‹çš„é¡ºåºæ’åˆ—ã€‚`;

  const fullPrompt = `${systemPrompt}\n\n${userPrompt}`;

  try {
    const responseText = await retryOperation(() => chatCompletion(fullPrompt, resolvedModel, 0.7, 4096, 'json_object'));
    const duration = Date.now() - startTime;

    const cleaned = cleanJsonString(responseText);
    const parsed = JSON.parse(cleaned);

    let panels: NineGridPanel[] = parsed.panels || [];

    if (panels.length < 9) {
      for (let i = panels.length; i < 9; i++) {
        panels.push({
          index: i,
          shotSize: 'ä¸­æ™¯',
          cameraAngle: 'å¹³è§†',
          description: `${actionSummary} - alternate angle ${i + 1}`
        });
      }
    } else if (panels.length > 9) {
      panels = panels.slice(0, 9);
    }

    panels = panels.map((p, idx) => ({ ...p, index: idx }));

    console.log(`âœ… ä¹å®«æ ¼åˆ†é•œ - AIæ‹†åˆ†å®Œæˆï¼Œè€—æ—¶: ${duration}ms`);
    return panels;
  } catch (error: any) {
    console.error('âŒ ä¹å®«æ ¼åˆ†é•œ - AIæ‹†åˆ†å¤±è´¥:', error);
    throw new Error(`ä¹å®«æ ¼è§†è§’æ‹†åˆ†å¤±è´¥: ${error.message}`);
  }
};

/**
 * ä½¿ç”¨å›¾åƒæ¨¡å‹ç”Ÿæˆä¹å®«æ ¼åˆ†é•œå›¾ç‰‡
 */
export const generateNineGridImage = async (
  panels: NineGridPanel[],
  referenceImages: string[] = [],
  visualStyle: string,
  aspectRatio: AspectRatio = '16:9',
  shotId?: string
): Promise<string> => {
  const startTime = Date.now();
  console.log('ğŸ¬ ä¹å®«æ ¼åˆ†é•œ - å¼€å§‹ç”Ÿæˆä¹å®«æ ¼å›¾ç‰‡...');

  const stylePrompt = getStylePrompt(visualStyle);

  const positionLabels = [
    'Top-Left', 'Top-Center', 'Top-Right',
    'Middle-Left', 'Center', 'Middle-Right',
    'Bottom-Left', 'Bottom-Center', 'Bottom-Right'
  ];

  const panelDescriptions = panels.map((panel, idx) =>
    `Panel ${idx + 1} (${positionLabels[idx]}): [${panel.shotSize} / ${panel.cameraAngle}] - ${panel.description}`
  ).join('\n');

  const nineGridPrompt = `Generate a SINGLE image composed as a cinematic storyboard with a 3x3 grid layout (9 equal panels).
The image shows the SAME scene from 9 DIFFERENT camera angles and shot sizes.
Each panel is separated by thin white borders.

Visual Style: ${stylePrompt}

Grid Layout (left to right, top to bottom):
${panelDescriptions}

CRITICAL REQUIREMENTS:
- The output MUST be a SINGLE image divided into exactly 9 equal rectangular panels in a 3x3 grid layout
- Each panel MUST have a thin white border/separator (2-3px) between panels
- All 9 panels show the SAME scene from DIFFERENT camera angles and shot sizes
- Maintain STRICT character consistency across ALL panels (same face, hair, clothing, body proportions)
- Maintain consistent lighting, color palette, and atmosphere across all panels
- Each panel should be a complete, well-composed frame suitable for use as a keyframe
- The overall image should read as a professional cinematographer's shot planning board`;

  try {
    const imageUrl = await generateImage(nineGridPrompt, referenceImages, aspectRatio, false, false, 'ninegrid', shotId);
    const duration = Date.now() - startTime;

    console.log(`âœ… ä¹å®«æ ¼åˆ†é•œ - å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼Œè€—æ—¶: ${duration}ms`);
    return imageUrl;
  } catch (error: any) {
    console.error('âŒ ä¹å®«æ ¼åˆ†é•œ - å›¾ç‰‡ç”Ÿæˆå¤±è´¥:', error);
    throw new Error(`ä¹å®«æ ¼å›¾ç‰‡ç”Ÿæˆå¤±è´¥: ${error.message}`);
  }
};
